<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hana Orchestrator - Layer Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
        }
        
        .card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        input[type="text"], input[type="url"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, input[type="url"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .layers-list {
            display: grid;
            gap: 15px;
        }
        
        .layer-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .layer-item h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .layer-item p {
            color: #666;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .functions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .function-badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .message {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .refresh-btn {
            background: #28a745;
            margin-left: 10px;
        }
        
        .refresh-btn:hover {
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }
        
        .execution-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .execution-item:hover {
            background: #e9ecef;
        }
        
        .execution-item.running {
            border-left-color: #ffc107;
            animation: pulse 2s infinite;
        }
        
        .execution-item.completed {
            border-left-color: #28a745;
        }
        
        .execution-item.failed {
            border-left-color: #dc3545;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .execution-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .execution-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .execution-meta {
            font-size: 12px;
            color: #666;
            display: flex;
            gap: 15px;
        }
        
        .execution-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            margin-top: 10px;
        }
        
        .execution-details.expanded {
            max-height: 1000px;
        }
        
        .execution-result {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-running {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        
        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .node-stats {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }
        
        .node-stat {
            font-size: 11px;
            color: #666;
        }
        
        .node-stat strong {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒŸ Hana Orchestrator</h1>
            <p>ë ˆì´ì–´ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</p>
        </div>
        
        <div class="card">
            <h2>ğŸ”— ì›ê²© ë ˆì´ì–´ ë“±ë¡</h2>
            <div id="registerMessage"></div>
            <form id="registerForm">
                <div class="form-group">
                    <label for="baseUrl">ì›ê²© ì„œë²„ URL:</label>
                    <input type="url" id="baseUrl" placeholder="http://localhost:8081" required>
                </div>
                <button type="submit">ë“±ë¡</button>
            </form>
        </div>
        
        <div class="card">
            <h2>
                ğŸ“‹ ë“±ë¡ëœ ë ˆì´ì–´ ëª©ë¡
                <button class="refresh-btn" onclick="loadLayers()">ìƒˆë¡œê³ ì¹¨</button>
            </h2>
            <div id="layersList">
                <p>ë¡œë”© ì¤‘...</p>
            </div>
        </div>
        
        <div class="card">
            <h2>
                ğŸš€ ì‹¤í–‰ ì´ë ¥
                <button class="refresh-btn" onclick="loadExecutions()">ìƒˆë¡œê³ ì¹¨</button>
                <label style="margin-left: 10px;">
                    <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()">
                    ìë™ ìƒˆë¡œê³ ì¹¨
                </label>
            </h2>
            <div id="executionsList" style="max-height: 300px; overflow-y: auto;">
                <p>ë¡œë”© ì¤‘...</p>
            </div>
        </div>
        
    </div>
    
    <script>
        const API_BASE = window.location.origin;
        
        // ë ˆì´ì–´ ëª©ë¡ ë¡œë“œ
        async function loadLayers() {
            const layersList = document.getElementById('layersList');
            layersList.innerHTML = '<p>ë¡œë”© ì¤‘...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/layers`);
                const layers = await response.json();
                
                if (layers.error) {
                    layersList.innerHTML = `<div class="message error">${layers.error}</div>`;
                    return;
                }
                
                if (layers.length === 0) {
                    layersList.innerHTML = '<p>ë“±ë¡ëœ ë ˆì´ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                
                layersList.innerHTML = layers.map(layer => `
                    <div class="layer-item">
                        <h3>${layer.name}</h3>
                        <p>${layer.description}</p>
                        <div class="functions">
                            ${layer.functions.map(func => `<span class="function-badge">${func}</span>`).join('')}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                layersList.innerHTML = `<div class="message error">ë ˆì´ì–´ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
            }
        }
        
        // ì›ê²© ë ˆì´ì–´ ë“±ë¡
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const baseUrl = document.getElementById('baseUrl').value;
            const messageDiv = document.getElementById('registerMessage');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            messageDiv.innerHTML = '';
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'ë“±ë¡ ì¤‘... <span class="loading"></span>';
            
            try {
                const response = await fetch(`${API_BASE}/layers/register-remote`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ baseUrl })
                });
                
                const result = await response.json();
                
                if (result.error) {
                    messageDiv.innerHTML = `<div class="message error">${result.error}</div>`;
                } else {
                    messageDiv.innerHTML = `<div class="message success">âœ… ${result.message}: ${result.layerName} (${result.baseUrl})</div>`;
                    document.getElementById('baseUrl').value = '';
                    loadLayers();
                }
            } catch (error) {
                messageDiv.innerHTML = `<div class="message error">ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'ë“±ë¡';
            }
        });
        
        let autoRefreshInterval = null;
        let wsConnection = null;
        
        // WebSocket ì—°ê²° (ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸)
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/executions`;
            
            wsConnection = new WebSocket(wsUrl);
            
            wsConnection.onopen = () => {
                console.log('WebSocket ì—°ê²°ë¨');
            };
            
            wsConnection.onmessage = (event) => {
                try {
                    if (!event.data || event.data.trim() === '') {
                        console.warn('ë¹ˆ WebSocket ë©”ì‹œì§€ ìˆ˜ì‹ ');
                        return;
                    }
                    const data = JSON.parse(event.data);
                    updateExecutionsUI(data);
                } catch (error) {
                    console.error('WebSocket ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:', error, 'ë°ì´í„°:', event.data);
                }
            };
            
            wsConnection.onerror = (error) => {
                console.error('WebSocket ì˜¤ë¥˜:', error);
                // í´ë§ìœ¼ë¡œ í´ë°±
                setTimeout(connectWebSocket, 3000);
            };
            
            wsConnection.onclose = () => {
                console.log('WebSocket ì—°ê²° ì¢…ë£Œ');
                // ì¬ì—°ê²° ì‹œë„
                setTimeout(connectWebSocket, 3000);
            };
        }
        
        // ì‹¤í–‰ ì´ë ¥ UI ì—…ë°ì´íŠ¸
        function updateExecutionsUI(data) {
            const executionsList = document.getElementById('executionsList');
            
            if (!data) {
                executionsList.innerHTML = '<p>ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            let html = '';
            
            // í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì‘ì—…
            if (data.current) {
                html += renderExecution(data.current, true);
            }
            
            // ì´ë ¥
            if (data.history && data.history.length > 0) {
                data.history.forEach(exec => {
                    html += renderExecution(exec, false);
                });
            } else if (!data.current) {
                html = '<p>ì‹¤í–‰ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
            
            executionsList.innerHTML = html;
            
            // ì ‘ê¸°/í¼ì¹˜ê¸° ì´ë²¤íŠ¸ ì¶”ê°€
            document.querySelectorAll('.execution-item').forEach(item => {
                // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ìƒˆë¡œ ì¶”ê°€
                const newItem = item.cloneNode(true);
                item.parentNode.replaceChild(newItem, item);
                newItem.addEventListener('click', function() {
                    const details = this.querySelector('.execution-details');
                    if (details) {
                        details.classList.toggle('expanded');
                    }
                });
            });
            
        }
        
        // ì‹¤í–‰ ì´ë ¥ ë¡œë“œ (í´ë§ ë°©ì‹ - í´ë°±ìš©)
        async function loadExecutions() {
            const executionsList = document.getElementById('executionsList');
            
            try {
                const response = await fetch(`${API_BASE}/executions`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                if (!text || text.trim() === '') {
                    executionsList.innerHTML = '<p>ì‹¤í–‰ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                
                const data = JSON.parse(text);
                
                if (data.error) {
                    executionsList.innerHTML = `<div class="message error">${data.error}</div>`;
                    return;
                }
                
                updateExecutionsUI(data);
            } catch (error) {
                console.error('ì‹¤í–‰ ì´ë ¥ ë¡œë“œ ì˜¤ë¥˜:', error);
                executionsList.innerHTML = `<div class="message error">ì‹¤í–‰ ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
            }
        }
        
        function renderExecution(exec, isCurrent) {
            const statusClass = exec.status.toLowerCase();
            const statusText = {
                'running': 'ì‹¤í–‰ ì¤‘',
                'completed': 'ì™„ë£Œ',
                'failed': 'ì‹¤íŒ¨'
            }[exec.status] || exec.status;
            
            const duration = exec.endTime 
                ? `${((exec.endTime - exec.startTime) / 1000).toFixed(2)}ì´ˆ`
                : isCurrent 
                    ? `${((Date.now() - exec.startTime) / 1000).toFixed(1)}ì´ˆ ê²½ê³¼`
                    : '';
            
            const timeStr = new Date(exec.startTime).toLocaleTimeString('ko-KR');
            
            return `
                <div class="execution-item ${statusClass}" data-id="${exec.id}">
                    <div class="execution-header">
                        <div>
                            <div class="execution-title">
                                ${isCurrent ? 'ğŸ”„ ' : ''}${exec.query || '(ë¹ˆ ì¿¼ë¦¬)'}
                            </div>
                            <div class="execution-meta">
                                <span>${timeStr}</span>
                                ${duration ? `<span>â±ï¸ ${duration}</span>` : ''}
                                <span class="status-badge status-${statusClass}">${statusText}</span>
                            </div>
                            <div class="node-stats">
                                ${exec.nodeCount > 0 ? `<span class="node-stat">ì „ì²´: <strong>${exec.nodeCount}</strong></span>` : ''}
                                ${exec.completedNodes > 0 ? `<span class="node-stat">âœ… ì„±ê³µ: <strong>${exec.completedNodes}</strong></span>` : ''}
                                ${exec.failedNodes > 0 ? `<span class="node-stat">âŒ ì‹¤íŒ¨: <strong>${exec.failedNodes}</strong></span>` : ''}
                                ${exec.runningNodes > 0 ? `<span class="node-stat">ğŸ”„ ì‹¤í–‰ì¤‘: <strong>${exec.runningNodes}</strong></span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="execution-details">
                        ${exec.result ? `
                            <div class="execution-result">
                                <strong>ê²°ê³¼:</strong><br>
                                ${exec.result}
                            </div>
                        ` : ''}
                        ${exec.error ? `
                            <div class="execution-result" style="background: #f8d7da; color: #721c24;">
                                <strong>ì—ëŸ¬:</strong><br>
                                ${exec.error}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            if (checkbox.checked) {
                // WebSocketì´ ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ í´ë§ ë¶ˆí•„ìš”
                if (!wsConnection || wsConnection.readyState !== WebSocket.OPEN) {
                    autoRefreshInterval = setInterval(() => {
                        loadLayers();
                    }, 5000); // ë ˆì´ì–´ ëª©ë¡ë§Œ 5ì´ˆë§ˆë‹¤ ìƒˆë¡œê³ ì¹¨
                }
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë ˆì´ì–´ ëª©ë¡ ë° ì‹¤í–‰ ì´ë ¥ ë¶ˆëŸ¬ì˜¤ê¸°
        loadLayers();
        loadExecutions(); // ì´ˆê¸° ë¡œë“œ
        connectWebSocket(); // WebSocket ì—°ê²° ì‹œì‘
    </script>
</body>
</html>
